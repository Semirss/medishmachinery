<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>medish machinary - Rent & Buy Heavy Machinery</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          'heading': ['Exo 2', 'sans-serif'],
          'body': ['Inter', 'sans-serif'],
        },
        colors: {
          'industrial': {
            'yellow': '#FFB347',
            'orange': '#FF8C00',
            'gray': '#2D3748',
            'blue': '#4299E1',
            'safety': '#FF6B35',
            'green': '#10B981',
            'dark': '#1A202C'
          }
        },
        boxShadow: {
          'card': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
          'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
        },
        animation: {
          'fade-in': 'fadeIn 0.5s ease-in-out',
          'slide-up': 'slideUp 0.3s ease-out',
          'pulse-border': 'pulse-border 2s infinite',
        },
        keyframes: {
          fadeIn: {
            '0%': { opacity: '0' },
            '100%': { opacity: '1' },
          },
          slideUp: {
            '0%': { transform: 'translateY(10px)', opacity: '0' },
            '100%': { transform: 'translateY(0)', opacity: '1' },
          },
          'pulse-border': {
            '0%': { boxShadow: '0 0 0 0 rgba(255, 179, 71, 0.7)' },
            '70%': { boxShadow: '0 0 0 10px rgba(255, 179, 71, 0)' },
            '100%': { boxShadow: '0 0 0 0 rgba(255, 179, 71, 0)' },
          }
        }
      }
    }
  }
</script>
<style>
  body { font-family: 'Inter', sans-serif; }
  .hero-bg {
    background-image: radial-gradient(circle at 10% 20%, rgba(255, 179, 71, 0.2) 0%, transparent 20%),
                      radial-gradient(circle at 90% 80%, rgba(255, 140, 0, 0.15) 0%, transparent 20%);
  }
  .safety-stripes {
    background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 107, 53, 0.05) 10px, rgba(255, 107, 53, 0.05) 20px);
  }
  .modal-overlay { cursor: pointer; }
  .modal-content { cursor: auto; }
  .gear-icon {
    display: inline-block;
    width: 24px;
    height: 24px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z'%3E%3C/path%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
  }
  .payment-method, .delivery-option {
    transition: all 0.3s ease;
  }
  .payment-method:hover, .delivery-option:hover {
    transform: translateY(-2px);
  }
  .payment-method.selected, .delivery-option.selected {
    border-color: #FFB347;
    background-color: rgba(255, 179, 71, 0.05);
  }
  .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid #E5E7EB;
  }
  .step-number.active {
    background-color: #FFB347;
    color: white;
    border-color: #FFB347;
  }
  .step-number.completed {
    background-color: #10B981;
    color: white;
    border-color: #10B981;
  }
</style>
</head>

<body class="bg-gray-50 font-body safety-stripes">

<!-- Navigation -->
<nav class="bg-industrial-gray text-white px-4 md:px-8 py-4 flex justify-between items-center shadow-lg sticky top-0 z-40">
  <div class="flex items-center space-x-3">
    <div class="gear-icon bg-industrial-yellow p-2 rounded-lg"></div>
    <h1 class="font-heading font-bold text-xl md:text-2xl tracking-tight">Medish <span class="text-industrial-yellow">Mashinary</span></h1>
  </div>
  <div class="flex items-center space-x-4 md:space-x-6">
    <button onclick="openOrders()" class="relative p-2 hover:bg-white/10 rounded-lg transition-colors">
      <span class="text-xl md:text-2xl">üìã</span>
      <span id="ordersBadge" class="absolute -top-1 -right-1 bg-industrial-green text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </button>
    <button onclick="openWishlist()" class="relative p-2 hover:bg-white/10 rounded-lg transition-colors">
      <span class="text-xl md:text-2xl">üíõ</span>
      <span id="wishlistBadge" class="absolute -top-1 -right-1 bg-industrial-blue text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </button>
    <button onclick="openCart()" class="relative p-2 hover:bg-white/10 rounded-lg transition-colors">
      <span class="text-xl md:text-2xl">üõí</span>
      <span id="cartBadge" class="absolute -top-1 -right-1 bg-industrial-yellow text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </button>
        <a href="admin.html" class="text-sm md:text-base hover:text-industrial-yellow transition-colors duration-200 p-2">
      üë§
    </a>
  </div>
</nav>

<!-- Hero Section -->
<section class="hero-bg bg-gradient-to-r from-industrial-dark to-industrial-gray py-12 md:py-16 text-center relative overflow-hidden">
  <div class="relative max-w-4xl mx-auto px-4">
    <h2 class="font-heading text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-white drop-shadow-lg">
      Rent or Buy <span class="text-industrial-yellow">Heavy Machinery</span>
    </h2>
    <p class="text-lg md:text-xl text-gray-300 mb-8">Premium equipment with full inspection details, negotiation options, and easy booking.</p>
    
    <!-- Type Toggle -->
    <div class="inline-flex bg-white/10 p-1 rounded-xl backdrop-blur-sm border border-white/20">
      <button onclick="setListingType('Rent')" id="btnRent" class="px-8 py-3 rounded-lg font-bold transition-all text-industrial-gray bg-industrial-yellow shadow-lg">
        For Rent
      </button>
      <button onclick="setListingType('Sale')" id="btnSale" class="px-8 py-3 rounded-lg font-bold transition-all text-white hover:bg-white/10">
        For Sale
      </button>
    </div>
  </div>
</section>

<!-- Main Content -->
<section class="p-4 md:p-8 max-w-7xl mx-auto">
  <!-- Filters -->
  <div class="mb-8 bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="relative">
        <span class="absolute left-3 top-3.5 text-gray-400">üîç</span>
        <input type="text" id="searchInput" oninput="performSearch()" placeholder="Search by name, brand, or model..." 
          class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/20 outline-none">
      </div>
      
      <div>
        <select id="categoryFilter" onchange="filterByCategory(this.value)" 
          class="w-full p-3 rounded-xl border border-gray-200 focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/20 outline-none bg-white">
          <option value="All">All Categories</option>
          <!-- Populated via JS -->
        </select>
      </div>

      <div class="flex items-center justify-end">
        <p id="resultsCount" class="text-gray-600 font-medium">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Grid -->
  <div id="machineGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"></div>
  
  <!-- Pagination -->
  <div id="paginationControls" class="flex flex-col sm:flex-row justify-between items-center mt-10 md:mt-12 space-y-4 sm:space-y-0">
    <div class="text-gray-600 text-sm md:text-base text-center sm:text-left">
      Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> machines
    </div>
    <div class="flex items-center space-x-3">
      <button onclick="changePage(-1)" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center font-medium">
        &larr; Previous
      </button>
      <span id="pageStatus" class="text-gray-700 font-medium px-4 py-2 bg-gray-100 rounded-lg">Page 1 of 1</span>
      <button onclick="changePage(1)" id="nextBtn" class="bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center font-medium">
        Next &rarr;
      </button>
    </div>
  </div>
</section>

<!-- Trust Indicators Section -->
<section class="bg-white py-12 md:py-16 px-4 md:px-8 mt-8 md:mt-12 shadow-inner">
  <div class="max-w-6xl mx-auto">
    <h3 class="font-heading text-2xl md:text-3xl font-bold text-center mb-10 md:mb-12 text-industrial-gray">Why Choose medish machinary?</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 md:gap-8">
      <div class="text-center p-6 rounded-2xl bg-gradient-to-br from-gray-50 to-white shadow-card hover:shadow-card-hover transition-all duration-300">
        <div class="text-4xl mb-4">üõ°Ô∏è</div>
        <h4 class="font-heading font-bold text-lg mb-2">Full Insurance</h4>
        <p class="text-gray-600 text-sm">Every rental includes comprehensive insurance coverage</p>
      </div>
      <div class="text-center p-6 rounded-2xl bg-gradient-to-br from-gray-50 to-white shadow-card hover:shadow-card-hover transition-all duration-300">
        <div class="text-4xl mb-4">üöö</div>
        <h4 class="font-heading font-bold text-lg mb-2">Free Delivery</h4>
        <p class="text-gray-600 text-sm">On-site delivery within 50 miles at no extra cost</p>
      </div>
      <div class="text-center p-6 rounded-2xl bg-gradient-to-br from-gray-50 to-white shadow-card hover:shadow-card-hover transition-all duration-300">
        <div class="text-4xl mb-4">üîß</div>
        <h4 class="font-heading font-bold text-lg mb-2">Certified Maintenance</h4>
        <p class="text-gray-600 text-sm">All equipment regularly serviced by certified technicians</p>
      </div>
      <div class="text-center p-6 rounded-2xl bg-gradient-to-br from-gray-50 to-white shadow-card hover:shadow-card-hover transition-all duration-300">
        <div class="text-4xl mb-4">‚≠ê</div>
        <h4 class="font-heading font-bold text-lg mb-2">4.8/5 Rating</h4>
        <p class="text-gray-600 text-sm">Rated excellent by 500+ construction companies</p>
      </div>
    </div>
  </div>
</section>

<!-- Detail Modal (Includes Specs & Negotiation) -->
<div id="detailModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'detailModal')">
  <div class="bg-white max-w-4xl w-full rounded-2xl relative max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up modal-content" onclick="event.stopPropagation()">
    <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 bg-white/80 rounded-full p-2 hover:bg-gray-100 transition">&times;</button>
    
    <div id="detailContent" class="pb-8">
      <!-- Content populated by JS -->
    </div>
  </div>
</div>

<!-- Negotiation Modal -->
<div id="negotiationModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'negotiationModal')">
  <div class="bg-white max-w-lg w-full p-6 rounded-2xl relative shadow-2xl animate-fade-in modal-content" onclick="event.stopPropagation()">
    <h3 class="font-heading text-2xl font-bold mb-4 text-industrial-gray">Make an Offer</h3>
    <p class="text-gray-600 mb-6 text-sm">Negotiate the price or terms for this machinery.</p>
    
    <form id="negotiationForm" onsubmit="submitNegotiation(event)">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Proposed Price (<span id="currencyLabel">Daily Rate</span>)</label>
          <input type="number" id="offerPrice" required class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-industrial-yellow/30 outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Proposed Payment Terms</label>
          <select id="offerTerms" class="w-full p-3 border rounded-xl outline-none bg-white">
            <option value="Advance">Advance</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Message / Notes</label>
          <textarea id="offerNotes" rows="3" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-industrial-yellow/30 outline-none" placeholder="E.g., I need this for 6 months..."></textarea>
        </div>
      </div>
      <div class="mt-6 flex space-x-3">
        <button type="button" onclick="closeNegotiation()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium">Cancel</button>
        <button type="submit" class="flex-1 py-3 bg-industrial-yellow hover:bg-orange-500 text-white rounded-xl font-bold shadow-md">Submit Offer</button>
      </div>
    </form>
  </div>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'cartModal')">
  <div class="bg-white max-w-2xl w-full p-6 md:p-8 rounded-2xl relative shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
    <button onclick="closeCart()" class="absolute top-4 right-4 text-gray-500 text-2xl">&times;</button>
    <h2 class="font-heading text-2xl font-bold mb-6 text-industrial-gray">Your Cart / Inquiries</h2>
    <div id="cartItems" class="space-y-4"></div>
    <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
      <span class="font-bold text-xl">Estimated Total: <span id="cartTotal" class="text-industrial-yellow">$0</span></span>
      <button onclick="openCompleteBookingModal()" class="w-full md:w-auto px-8 py-3 bg-industrial-green text-white font-bold rounded-xl hover:bg-green-600 shadow-lg">Proceed to Checkout</button>
    </div>
  </div>
</div>

<!-- Complete Booking Modal -->
<div id="completeBookingModal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'completeBookingModal')">
  <div class="bg-white max-w-4xl w-full rounded-2xl relative shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
    <button onclick="closeCompleteBookingModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl z-10">&times;</button>
    <div class="p-6 md:p-8">
      <h2 class="font-heading text-2xl md:text-3xl font-bold mb-8 text-industrial-gray">Complete Your Booking</h2>
      
      <!-- Progress Steps -->
      <div class="flex items-center justify-between mb-10 relative">
        <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -translate-y-1/2 z-0"></div>
        <div class="absolute top-1/2 left-0 h-1 bg-industrial-yellow -translate-y-1/2 z-0" id="progressBar" style="width: 25%"></div>
        
        <div class="flex flex-col items-center relative z-10">
          <div class="step-number ${currentStep >= 1 ? 'active' : ''}">1</div>
        </div>
        
        <div class="flex flex-col items-center relative z-10">
          <div class="step-number ${currentStep >= 2 ? 'active' : ''}">2</div>
        </div>
        
        <div class="flex flex-col items-center relative z-10">
          <div class="step-number ${currentStep >= 3 ? 'active' : ''}">3</div>
        </div>
        
        <div class="flex flex-col items-center relative z-10">
          <div class="step-number ${currentStep >= 4 ? 'active' : ''}">4</div>
        </div>
      </div>
      
      <!-- Step 1: Contact Information -->
      <div id="step1" class="space-y-6">
        <h3 class="font-heading text-xl font-bold text-industrial-gray mb-6">Contact Information</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block font-medium text-gray-700 mb-2">Full Name *</label>
            <input type="text" id="bookingName" placeholder="John Smith" 
              class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/30 focus:outline-none transition-all duration-200">
          </div>
          
          <div>
            <label class="block font-medium text-gray-700 mb-2">Email Address *</label>
            <input type="email" id="bookingEmail" placeholder="john@example.com" 
              class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/30 focus:outline-none transition-all duration-200">
          </div>
          
          <div>
            <label class="block font-medium text-gray-700 mb-2">Phone Number *</label>
            <input type="tel" id="bookingPhone" placeholder="(555) 123-4567" 
              class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/30 focus:outline-none transition-all duration-200">
          </div>
          
          <div>
            <label class="block font-medium text-gray-700 mb-2">Company Name (Optional)</label>
            <input type="text" id="bookingCompany" placeholder="ABC Construction Inc." 
              class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/30 focus:outline-none transition-all duration-200">
          </div>
        </div>
        
        <div class="mt-4">
          <label class="block font-medium text-gray-700 mb-2">Address (Required for delivery)</label>
          <textarea id="bookingAddress" rows="3" placeholder="123 Main Street, Apt 4B, City, State, ZIP" 
            class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-industrial-yellow focus:ring-2 focus:ring-industrial-yellow/30 focus:outline-none transition-all duration-200"></textarea>
          <p class="text-sm text-gray-500 mt-2">Required if selecting delivery. Optional for pickup.</p>
        </div>
        
        <div class="flex justify-end mt-8">
          <button onclick="nextStep(2)" class="bg-industrial-yellow hover:bg-orange-500 text-white px-8 py-3 rounded-xl font-bold transition-colors duration-200">
            Next: Delivery Options
          </button>
        </div>
      </div>
      
      <!-- Step 2: Delivery Options -->
      <div id="step2" class="space-y-6 hidden">
        <h3 class="font-heading text-xl font-bold text-industrial-gray mb-6">Delivery Options</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="delivery-option border-2 border-gray-200 p-6 rounded-2xl cursor-pointer" 
               onclick="selectDeliveryOption('pickup', this)">
            <div class="flex items-start space-x-4">
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <span class="text-2xl">üöó</span>
              </div>
              <div>
                <h4 class="font-heading font-bold text-lg mb-2">Pickup at Our Location</h4>
                <p class="text-gray-600">Pick up equipment from our warehouse at:</p>
                <p class="text-sm text-gray-700 mt-2 font-medium">789 Industrial Way, City, State 12345</p>
                <p class="text-sm text-gray-500 mt-1">Hours: Mon-Fri 7AM-6PM, Sat 8AM-4PM</p>
                <p class="text-green-600 font-bold mt-2">FREE</p>
              </div>
            </div>
          </div>
          
          <div class="delivery-option border-2 border-gray-200 p-6 rounded-2xl cursor-pointer" 
               onclick="selectDeliveryOption('delivery', this)">
            <div class="flex items-start space-x-4">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <span class="text-2xl">üöö</span>
              </div>
              <div>
                <h4 class="font-heading font-bold text-lg mb-2">Delivery to Site</h4>
                <p class="text-gray-600">We'll deliver and pick up from your location</p>
                <p class="text-sm text-gray-700 mt-2 font-medium">Within 50 miles: FREE</p>
                <p class="text-sm text-gray-500 mt-1">Beyond 50 miles: $2.50 per mile</p>
                <p class="text-green-600 font-bold mt-2">FREE (within 50 miles)</p>
              </div>
            </div>
          </div>
        </div>
        
        <div id="deliveryDetails" class="hidden mt-6">
          <h4 class="font-heading font-bold text-lg mb-4">Delivery Details</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block font-medium text-gray-700 mb-2">Preferred Delivery Date *</label>
              <input type="date" id="deliveryDate" class="w-full border-2 border-gray-200 p-3 rounded-xl">
            </div>
            <div>
              <label class="block font-medium text-gray-700 mb-2">Delivery Time Window *</label>
              <select id="deliveryTime" class="w-full border-2 border-gray-200 p-3 rounded-xl">
                <option value="">Select a time</option>
                <option value="morning">Morning (7AM-11AM)</option>
                <option value="afternoon">Afternoon (11AM-3PM)</option>
                <option value="evening">Evening (3PM-6PM)</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label class="block font-medium text-gray-700 mb-2">Special Instructions</label>
            <textarea id="deliveryInstructions" rows="2" placeholder="Gate code, special access requirements, etc." 
              class="w-full border-2 border-gray-200 p-3 rounded-xl"></textarea>
          </div>
        </div>
        
        <div class="flex justify-between mt-8">
          <button onclick="prevStep(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-xl font-medium transition-colors duration-200">
            ‚Üê Back
          </button>
          <button onclick="nextStep(3)" class="bg-industrial-yellow hover:bg-orange-500 text-white px-8 py-3 rounded-xl font-bold transition-colors duration-200">
            Next: Payment Method
          </button>
        </div>
      </div>
      
      <!-- Step 3: Payment Method -->
      <div id="step3" class="space-y-6 hidden">
        <h3 class="font-heading text-xl font-bold text-industrial-gray mb-6">Payment Method</h3>
        
        <div class="space-y-4">
          <div class="payment-method border-2 border-gray-200 p-6 rounded-2xl cursor-pointer" 
               onclick="selectPaymentMethod('cash', this)">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl">üíµ</span>
                </div>
                <div>
                  <h4 class="font-heading font-bold text-lg mb-1">Cash on Delivery/Acceptance</h4>
                  <p class="text-gray-600">Pay when equipment is delivered or picked up</p>
                </div>
              </div>
              <div class="text-green-600 font-bold">Pay Later</div>
            </div>
          </div>
          
          <div class="payment-method border-2 border-gray-200 p-6 rounded-2xl cursor-pointer" 
               onclick="selectPaymentMethod('bank', this)">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl">üè¶</span>
                </div>
                <div>
                  <h4 class="font-heading font-bold text-lg mb-1">Bank Transfer</h4>
                  <p class="text-gray-600">Transfer funds to our account. Booking confirmed after payment verification.</p>
                  <div class="mt-2 text-sm bg-blue-50 p-3 rounded-lg">
                    <p class="font-medium">Account Details:</p>
                    <p>Bank: First National Bank</p>
                    <p>Account: 1234567890</p>
                    <p>Routing: 021000021</p>
                    <p class="text-red-600 mt-1">Please include Order ID as reference</p>
                  </div>
                </div>
              </div>
              <div class="text-blue-600 font-bold">Pay Now</div>
            </div>
          </div>
        </div>
        
        <div id="bankTransferInfo" class="hidden mt-6 bg-blue-50 p-6 rounded-2xl border border-blue-200">
          <h4 class="font-heading font-bold text-lg mb-3 text-blue-800">Important Instructions for Bank Transfer</h4>
          <ol class="list-decimal pl-5 space-y-2 text-blue-700">
            <li>Use the Order ID shown on confirmation as payment reference</li>
            <li>Send payment to account details shown above</li>
            <li>Your booking will be confirmed within 24 hours after payment verification</li>
            <li>Contact support@medish machinary.com for assistance</li>
          </ol>
        </div>
        
        <div class="flex justify-between mt-8">
          <button onclick="prevStep(2)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-xl font-medium transition-colors duration-200">
            ‚Üê Back
          </button>
          <button onclick="nextStep(4)" class="bg-industrial-yellow hover:bg-orange-500 text-white px-8 py-3 rounded-xl font-bold transition-colors duration-200">
            Next: Review & Confirm
          </button>
        </div>
      </div>
      
      <!-- Step 4: Review & Confirm -->
      <div id="step4" class="space-y-6 hidden">
        <h3 class="font-heading text-xl font-bold text-industrial-gray mb-6">Review Your Booking</h3>
        
        <div class="bg-gray-50 p-6 rounded-2xl">
          <h4 class="font-heading font-bold text-lg mb-4">Order Summary</h4>
          <div id="orderSummary"></div>
          <div class="flex justify-between items-center mt-6 pt-6 border-t border-gray-300">
            <span class="font-heading font-bold text-xl">Total Amount</span>
            <span id="orderTotal" class="font-heading font-bold text-2xl text-industrial-yellow">$0</span>
          </div>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-2xl">
          <h4 class="font-heading font-bold text-lg mb-4">Customer Information</h4>
          <div id="customerInfo"></div>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-2xl">
          <h4 class="font-heading font-bold text-lg mb-4">Delivery & Payment</h4>
          <div id="deliveryPaymentInfo"></div>
        </div>
        
        <div class="flex items-start mt-6">
          <input type="checkbox" id="termsAgreement" class="mt-1 mr-3">
          <label for="termsAgreement" class="text-gray-700">
            I agree to the <a href="#" class="text-industrial-blue underline">Terms and Conditions</a> and understand that equipment must be returned in the same condition. I am responsible for any damages beyond normal wear and tear.
          </label>
        </div>
        
        <div class="flex justify-between mt-8">
          <button onclick="prevStep(3)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-xl font-medium transition-colors duration-200">
            ‚Üê Back
          </button>
          <button onclick="submitBooking()" class="bg-industrial-green hover:bg-green-600 text-white px-8 py-3 rounded-xl font-bold transition-colors duration-200 flex items-center">
            <span id="submitButtonText">Confirm & Place Order</span>
            <span id="loadingSpinner" class="hidden ml-2">‚è≥</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Orders Modal -->
<div id="ordersModal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'ordersModal')">
  <div class="bg-white max-w-4xl w-full rounded-2xl relative shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
    <button onclick="closeOrders()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl z-10">&times;</button>
    <div class="p-6 md:p-8">
      <h2 class="font-heading text-2xl md:text-3xl font-bold mb-6 text-industrial-gray">My Orders</h2>
      
      <div class="flex flex-wrap gap-2 mb-6">
        <button onclick="filterOrders('all')" class="px-4 py-2 rounded-xl bg-industrial-gray text-white font-medium">All</button>
        <button onclick="filterOrders('pending')" class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-medium">Pending</button>
        <button onclick="filterOrders('confirmed')" class="px-4 py-2 rounded-xl bg-blue-500 text-white font-medium">Confirmed</button>
        <button onclick="filterOrders('completed')" class="px-4 py-2 rounded-xl bg-green-500 text-white font-medium">Completed</button>
        <button onclick="filterOrders('cancelled')" class="px-4 py-2 rounded-xl bg-red-500 text-white font-medium">Cancelled</button>
      </div>
      
      <div id="ordersList" class="space-y-6">
        <!-- Orders will be loaded here -->
      </div>
      
      <div id="noOrders" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">üìã</div>
        <h3 class="font-heading text-xl font-bold text-gray-700 mb-2">No Orders Yet</h3>
        <p class="text-gray-500">Your orders will appear here once you make a booking</p>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'confirmModal')">
  <div class="bg-white p-8 rounded-2xl max-w-md text-center shadow-2xl animate-fade-in modal-content" onclick="event.stopPropagation()">
    <div class="text-6xl mb-6" id="confirmIcon">üéâ</div>
    <h2 class="font-heading text-2xl md:text-3xl font-bold mb-4 text-industrial-gray" id="confirmTitle">Booking Confirmed!</h2>
    <p class="mb-4 text-gray-600" id="confirmMessage">Your rental has been successfully booked. A confirmation email has been sent.</p>
    <p class="mb-6 font-mono bg-gray-100 p-3 rounded-lg" id="orderIdDisplay"></p>
    <button onclick="closeConfirm()" class="bg-industrial-yellow hover:bg-orange-500 px-8 py-3 rounded-xl font-bold text-white transition-colors duration-200">
      Done
    </button>
  </div>
</div>

<!-- Wishlist Modal -->
<div id="wishlistModal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay" onclick="closeModalOnOutsideClick(event, 'wishlistModal')">
  <div class="bg-white max-w-xl w-full p-6 md:p-8 rounded-2xl relative shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
    <button onclick="closeWishlist()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="font-heading text-2xl md:text-3xl font-bold mb-6 text-industrial-gray">Your Wishlist</h2>
    <p class="mb-6 text-sm md:text-base text-gray-600 bg-yellow-50 p-4 rounded-xl border border-yellow-100">These items are currently unavailable but you'll be notified when they are back in stock.</p>
    <div id="wishlistItems"></div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-industrial-dark text-white py-12 mt-12">
  <div class="max-w-7xl mx-auto px-4 text-center md:text-left grid md:grid-cols-4 gap-8">
    <div class="col-span-1 md:col-span-2">
      <div class="flex items-center space-x-3 mb-4">
        <div class="gear-icon bg-industrial-yellow p-2 rounded-lg"></div>
        <h3 class="font-heading font-bold text-2xl">Medish<span class="text-industrial-yellow">Machinary</span></h3>
      </div>
      <p class="text-gray-400 text-sm max-w-xs">Connecting projects with the best machinery. Rent or buy with confidence.</p>
    </div>
    <div>
      <h4 class="font-bold mb-4 text-industrial-yellow">Contact</h4>
      <p class="text-gray-400 text-sm">üìû (555) 123-4567</p>
      <p class="text-gray-400 text-sm">‚úâÔ∏è support@medish machinary.com</p>
    </div>
    <div>
      <h4 class="font-bold mb-4 text-industrial-yellow">Office</h4>
      <p class="text-gray-400 text-sm">789 Industrial Way</p>
      <p class="text-gray-400 text-sm">Construction City, ST 12345</p>
      <p class="text-gray-400 text-sm mt-2">Hours: Mon-Fri 7AM-6PM, Sat 8AM-4PM</p>
    </div>
  </div>
  <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400 text-sm">
    ¬© 2024 medish machinary. All rights reserved. | <span class="text-industrial-yellow">üîí Secure Booking</span>
  </div>
</footer>

<script>
/* ---------- GLOBAL STATE ---------- */
const today = new Date().toISOString().split('T')[0];
const ITEMS_PER_PAGE = 9;
let currentPage = 1;
let currentListingType = 'Rent';
let currentCategory = 'All';
let searchQuery = '';
let currentMachineId = null;
let currentStep = 1;
let selectedDeliveryOption = null;
let selectedPaymentMethod = null;

/* ---------- DATA INITIALIZATION ---------- */
const machineTypes = {
  EXCAVATOR: 'Excavator',
  DOZER: 'Dozer',
  GRADER: 'Grader',
  LOADER: 'Loader',
  ROLLER: 'Roller',
  CRANE: 'Crane',
  WATER_TRUCK: 'Water Truck',
  DUMP_TRUCK: 'Dump Truck'
};
// Initial Data Seeding
const initialMachines = [
  {
    id: 101,
    type: machineTypes.EXCAVATOR,
    listingType: 'Rent',
    name: "CAT 320D Excavator",
    price: 350,
    image: "https://www.bossmachinery.nl/data/images/vehicles/l_01_Caterpillar%20320D%20-%20BM3815_005.JPG",
    status: "Available",
    condition: "Excellent",
    rating: 4.8,
    lastService: "2025-07-10",
    safetyNotes: "Operator certification required. Helmet and safety boots mandatory.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Project Site Alpha",
      inspectionLoc: "Main Yard, Zone B",
      year: 2021,
      brand: "Caterpillar",
      model: "320D",
      paymentTerms: "Monthly",
      workingHours: "10 hrs",
      idleTime: "4 hrs",
      fuel: "Without Fuel",
      transport: "To & From (Client Scope)"
    },
    specs: {
      bucketSize: "1.2 m¬≥",
      enginePower: "150 HP",
      mobility: "Chain (Track)"
    }
  },

  {
    id: 102,
    type: machineTypes.DOZER,
    listingType: 'Sale',
    name: "Komatsu D155A Dozer",
    price: 185000,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTKU_nzWFa7ctch_Zf8Fi8ygfSBwmKTi9Z9fA&s",
    status: "Available",
    condition: "Excellent",
    rating: 4.7,
    lastService: "2025-06-28",
    safetyNotes: "Requires experienced operator. Check blade condition before use.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Warehouse Central",
      inspectionLoc: "Warehouse Central",
      year: 2020,
      brand: "Komatsu",
      model: "D155A",
      paymentTerms: "Advance 50%",
      workingHours: "N/A",
      idleTime: "N/A",
      fuel: "N/A",
      transport: "Client Arrangement"
    },
    specs: {
      bladeType: "Semi-U",
      enginePower: "320 HP",
      ripper: "Multi-Shank"
    }
  },

  {
    id: 103,
    type: machineTypes.GRADER,
    listingType: 'Rent',
    name: "Motor Grader 140K",
    price: 400,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT8S_CiqyKRCUS0uCB-9fl4cUFZDAFln5cwlg&s",
    status: "Rented",
    condition: "Good",
    rating: 4.6,
    lastService: "2025-05-20",
    safetyNotes: "Do not exceed load limit. Use on level ground only.",
    availableFrom: "2024-02-01",
    bookings: [],
    common: {
      location: "Highway Project B",
      inspectionLoc: "Site Office B",
      year: 2019,
      brand: "CAT",
      model: "140K",
      paymentTerms: "Quarterly",
      workingHours: "8 hrs",
      idleTime: "6 hrs",
      fuel: "With Fuel",
      transport: "Included One Way"
    },
    specs: {
      horsePower: "190 HP",
      bladeWidth: "4.2 m"
    }
  },

  {
    id: 104,
    type: machineTypes.LOADER,
    listingType: 'Rent',
    name: "Wheel Loader 966H",
    price: 300,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_1PaSgo3GLuWKv1kNZ20ZsO1i_rGghU1Obg&s",
    status: "Available",
    condition: "Excellent",
    rating: 4.9,
    lastService: "2025-08-01",
    safetyNotes: "Keep arms and legs inside cab. Check stability indicators.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Quarry Site X",
      inspectionLoc: "Quarry Site X",
      year: 2022,
      brand: "CAT",
      model: "966H",
      paymentTerms: "Monthly",
      workingHours: "10 hrs",
      idleTime: "4 hrs",
      fuel: "Without Fuel",
      transport: "To & From"
    },
    specs: {
      loaderType: "Regular Loader",
      liftCapacity: "800 kg",
      reach: "2.5 m"
    }
  },

  {
    id: 105,
    type: machineTypes.ROLLER,
    listingType: 'Sale',
    name: "Vibratory Roller SD110",
    price: 45000,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTFSVsugy1_W4cqHnaK8KLDuQahJFq7_6XcXA&s",
    status: "Available",
    condition: "Good",
    rating: 4.5,
    lastService: "2025-05-15",
    safetyNotes: "Wear ear protection. Maintain safe distance from edge of slope.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Dealer Yard",
      inspectionLoc: "Dealer Yard",
      year: 2023,
      brand: "Volvo",
      model: "SD110",
      paymentTerms: "Full Advance",
      workingHours: "N/A",
      idleTime: "N/A",
      fuel: "N/A",
      transport: "Ex-Works"
    },
    specs: {
      weight: "11 Ton",
      drumType: "Single Drum",
      vibrationFrequency: "33 Hz"
    }
  },

  {
    id: 106,
    type: machineTypes.CRANE,
    listingType: 'Rent',
    name: "Mobile Crane 50T",
    price: 600,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQe-0_YlbpfzSZhEjUbo-HJbziEj6FZDatmcQ&s",
    status: "Available",
    condition: "Good",
    rating: 4.4,
    lastService: "2025-08-15",
    safetyNotes: "Requires spotter during full extension. Check load charts.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "City Depot",
      inspectionLoc: "City Depot",
      year: 2018,
      brand: "XCMG",
      model: "QY50K",
      paymentTerms: "Monthly",
      workingHours: "10 hrs",
      idleTime: "4 hrs",
      fuel: "Without Fuel",
      transport: "To & From"
    },
    specs: {
      craneType: "Mobile",
      capacity: "50 Ton",
      maxReach: "15 m"
    }
  },

  {
    id: 107,
    type: machineTypes.WATER_TRUCK,
    listingType: 'Rent',
    name: "Water Tanker",
    price: 150,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT986-Gu62CB-Rso3DwODHiYc4QZigQqeNxcQ&s",
    status: "Available",
    condition: "Good",
    rating: 4.3,
    lastService: "2025-10-20",
    safetyNotes: "Check water levels. Use only in well-ventilated areas.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Site C",
      inspectionLoc: "Site C",
      year: 2020,
      brand: "Sinotruk",
      model: "Howo",
      paymentTerms: "Monthly",
      workingHours: "10 hrs",
      idleTime: "4 hrs",
      fuel: "With Fuel",
      transport: "N/A"
    },
    specs: {
      capacity: "20,000 Liters",
      discharge: "Pump Powered"
    }
  },

  {
    id: 108,
    type: machineTypes.DUMP_TRUCK,
    listingType: 'Rent',
    name: "Heavy Dump Truck",
    price: 250,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQDdeOX2_MKXEY6xBqnozjGx8rF9Ix4x9c77Q&s",
    status: "Available",
    condition: "Excellent",
    rating: 4.8,
    lastService: "2025-11-01",
    safetyNotes: "Requires CDL. Check bed lock before driving.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Mining Zone",
      inspectionLoc: "Mining Zone",
      year: 2021,
      brand: "Mercedes",
      model: "Actros",
      paymentTerms: "Monthly",
      workingHours: "10 hrs",
      idleTime: "4 hrs",
      fuel: "Without Fuel",
      transport: "To & From"
    },
    specs: {
      capacity: "18 m¬≥",
      payload: "5,000 kg",
      fuelType: "Diesel"
    }
  },

  {
    id: 109,
    type: machineTypes.EXCAVATOR,
    listingType: 'Sale',
    name: "Mini Excavator 1.8T",
    price: 32000,
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3jqbJKdciLP79mU3fwx2Yc6Zx0fiek9g8DQ&s",
    status: "Available",
    condition: "New",
    rating: 4.9,
    lastService: "2025-12-01",
    safetyNotes: "Compact machine - ideal for tight spaces. ROPS certified.",
    availableFrom: today,
    bookings: [],
    common: {
      location: "Urban Depot",
      inspectionLoc: "Urban Depot",
      year: 2024,
      brand: "Kubota",
      model: "KX018-4",
      paymentTerms: "Full Advance",
      workingHours: "N/A",
      idleTime: "N/A",
      fuel: "N/A",
      transport: "Client Arrangement"
    },
    specs: {
      weight: "1.8 Ton",
      bucketSize: "0.05 m¬≥",
      enginePower: "14.5 HP"
    }
  }
];

// Initialize Storage
if (!localStorage.getItem("machines")) {
  localStorage.setItem("machines", JSON.stringify(initialMachines));
}
else {
  const existingMachines = JSON.parse(localStorage.getItem("machines"));
  const updatedMachines = existingMachines.map(machine => {
    if (!machine.bookings) {
      machine.bookings = [];
    }
    return machine;
  });
  localStorage.setItem("machines", JSON.stringify(updatedMachines));
}
if (!localStorage.getItem("cart")) localStorage.setItem("cart", JSON.stringify([]));
if (!localStorage.getItem("wishlist")) localStorage.setItem("wishlist", JSON.stringify([]));
if (!localStorage.getItem("orders")) localStorage.setItem("orders", JSON.stringify([]));

/* ---------- UTILITY FUNCTIONS ---------- */
function closeModalOnOutsideClick(event, modalId) {
  if (event.target.classList.contains('modal-overlay')) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('hidden');
    }
  }
}

function updateNavigationBadges() {
  const cart = JSON.parse(localStorage.getItem("cart"));
  const wishlist = JSON.parse(localStorage.getItem("wishlist"));
  const orders = JSON.parse(localStorage.getItem("orders"));
  
  const activeOrders = orders.filter(order => 
    order.status === 'pending' || order.status === 'pending_payment'
  ).length;
  
  const cartBadge = document.getElementById("cartBadge");
  const wishlistBadge = document.getElementById("wishlistBadge");
  const ordersBadge = document.getElementById("ordersBadge");
  
  if(cart.length > 0) { 
    cartBadge.innerText = cart.length; 
    cartBadge.classList.remove('hidden'); 
  } else {
    cartBadge.classList.add('hidden');
  }
  
  if(wishlist.length > 0) { 
    wishlistBadge.innerText = wishlist.length; 
    wishlistBadge.classList.remove('hidden'); 
  } else {
    wishlistBadge.classList.add('hidden');
  }
  
  if(activeOrders > 0) { 
    ordersBadge.innerText = activeOrders; 
    ordersBadge.classList.remove('hidden'); 
  } else {
    ordersBadge.classList.add('hidden');
  }
}

function generateOrderId() {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 10000);
  return `ORD-${timestamp}-${random}`;
}

/* ---------- CORE LISTING FUNCTIONS ---------- */
function setListingType(type) {
  currentListingType = type;
  
  const btnRent = document.getElementById('btnRent');
  const btnSale = document.getElementById('btnSale');
  
  if (type === 'Rent') {
    btnRent.className = "px-8 py-3 rounded-lg font-bold transition-all text-industrial-gray bg-industrial-yellow shadow-lg";
    btnSale.className = "px-8 py-3 rounded-lg font-bold transition-all text-white hover:bg-white/10";
  } else {
    btnSale.className = "px-8 py-3 rounded-lg font-bold transition-all text-industrial-gray bg-industrial-yellow shadow-lg";
    btnRent.className = "px-8 py-3 rounded-lg font-bold transition-all text-white hover:bg-white/10";
  }
  
  currentCategory = 'All';
  document.getElementById('categoryFilter').value = 'All';
  currentPage = 1;
  renderMachines();
}

function getFilteredMachines() {
  const machines = JSON.parse(localStorage.getItem("machines"));
  
  return machines.filter(m => {
    const typeMatch = m.listingType === currentListingType;
    const catMatch = currentCategory === 'All' || m.type === currentCategory;
    const searchMatch = m.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                        m.common.brand.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        m.type.toLowerCase().includes(searchQuery.toLowerCase());
    return typeMatch && catMatch && searchMatch;
  });
}

function renderMachines() {
  const filteredMachines = getFilteredMachines();
  const totalItems = filteredMachines.length;
  const grid = document.getElementById("machineGrid");
  
  document.getElementById('resultsCount').textContent = `Showing ${filteredMachines.length} ${currentListingType === 'Rent' ? 'Rentals' : 'Sales'}`;
  
  const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
  
  if (currentPage > totalPages && totalPages > 0) {
    currentPage = totalPages;
  } else if (totalPages === 0) {
    currentPage = 1;
  }
  
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const machinesToDisplay = filteredMachines.slice(startIndex, endIndex);
  
  grid.innerHTML = "";
  
  if (machinesToDisplay.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full text-center py-12">
        <div class="text-4xl mb-2">üîç</div>
        <p class="text-gray-500">No machinery found matching your criteria.</p>
        <button onclick="clearFilters()" class="mt-4 bg-industrial-yellow hover:bg-orange-500 text-white px-6 py-2 rounded-xl font-medium">
          Clear All Filters
        </button>
      </div>`;
  } else {
    machinesToDisplay.forEach(m => {
      const isRent = m.listingType === 'Rent';
      const priceDisplay = isRent ? `$${m.price}<span class="text-sm font-normal text-gray-500">/day</span>` : `$${m.price.toLocaleString()}`;
      
      const specsPreview = Object.entries(m.specs).slice(0,2).map(([key, val]) => 
        `<span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${val}</span>`
      ).join(' ');

      grid.innerHTML += `
        <div class="bg-white rounded-2xl overflow-hidden shadow-card hover:shadow-card-hover transition-all duration-300 group cursor-pointer" onclick="openDetail(${m.id})">
          <div class="relative h-56 overflow-hidden">
            <img src="${m.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" alt="${m.name}">
            <div class="absolute top-4 left-4">
              <span class="px-3 py-1 rounded-full text-xs font-bold text-white bg-black/50 backdrop-blur-md border border-white/20 uppercase tracking-wide">
                ${m.type}
              </span>
            </div>
            <div class="absolute bottom-4 right-4">
              <span class="px-3 py-1 rounded-full text-xs font-bold ${m.status === 'Available' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'} shadow-sm">
                ${m.status}
              </span>
            </div>
          </div>
          
          <div class="p-5">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-heading font-bold text-lg text-industrial-gray leading-tight">${m.name}</h3>
              <div class="flex items-center space-x-1">
                <span class="text-yellow-500">‚≠ê</span>
                <span class="font-semibold text-sm">${m.rating}</span>
              </div>
            </div>
            <p class="text-sm text-gray-500 mb-3">${m.common.year} ‚Ä¢ ${m.common.location}</p>
            
            <div class="flex flex-wrap gap-2 mb-4">
              ${specsPreview}
            </div>
            
            <div class="flex justify-between items-end border-t border-gray-100 pt-4">
              <div>
                <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">${isRent ? 'Rate' : 'Price'}</p>
                <p class="font-heading font-bold text-2xl text-industrial-yellow">${priceDisplay}</p>
                <p class="text-xs text-gray-500 mt-1">Condition: ${m.condition}</p>
              </div>
              <button class="bg-gray-100 hover:bg-industrial-gray hover:text-white text-gray-700 p-2 rounded-xl transition-colors">
                ‚ûî
              </button>
            </div>
          </div>
        </div>
      `;
    });
  }
  
  // Update pagination controls
  document.getElementById('prevBtn').disabled = currentPage === 1;
  document.getElementById('nextBtn').disabled = currentPage >= totalPages || totalPages === 0;
  
  const statusText = totalPages === 0 
    ? "Page 0 of 0" 
    : `Page ${currentPage} of ${totalPages}`;
    
  document.getElementById('pageStatus').textContent = statusText;
  document.getElementById('showingCount').textContent = machinesToDisplay.length;
  document.getElementById('totalCount').textContent = totalItems;
}

function changePage(direction) {
  const filteredMachines = getFilteredMachines();
  const totalPages = Math.ceil(filteredMachines.length / ITEMS_PER_PAGE);
  const newPage = currentPage + direction;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage = newPage;
    renderMachines();
    window.scrollTo({ top: document.getElementById('machineGrid').offsetTop - 100, behavior: 'smooth' });
  }
}

function performSearch() {
  searchQuery = document.getElementById("searchInput").value;
  currentPage = 1;
  renderMachines();
}

function filterByCategory(cat) {
  currentCategory = cat;
  currentPage = 1;
  renderMachines();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('categoryFilter').value = 'All';
  searchQuery = '';
  currentCategory = 'All';
  currentPage = 1;
  renderMachines();
}

/* ---------- DETAIL & NEGOTIATION FUNCTIONS ---------- */
function openDetail(id) {
  currentMachineId = id;
  const machines = JSON.parse(localStorage.getItem("machines"));
  const m = machines.find(x => x.id === id);
  const isRent = m.listingType === 'Rent';
  const isAvailable = m.status === "Available";
  
  let startDateValue = today;
  let endDateValue = "";
  
  if (!isAvailable && m.availableFrom) {
    startDateValue = m.availableFrom;
    const startDate = new Date(startDateValue);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 1);
    endDateValue = endDate.toISOString().split('T')[0];
  } else {
    const startDate = new Date(startDateValue);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 1);
    endDateValue = endDate.toISOString().split('T')[0];
  }
  
  // Helper for Spec rows
  const renderRow = (label, value) => `
    <div class="flex justify-between py-2 border-b border-dashed border-gray-200">
      <span class="text-gray-500 text-sm">${label}</span>
      <span class="font-medium text-industrial-gray text-right">${value}</span>
    </div>`;

  let specsHtml = '';
  specsHtml += renderRow('Location', m.common.location);
  specsHtml += renderRow('Inspection At', m.common.inspectionLoc);
  specsHtml += renderRow('Year', m.common.year);
  specsHtml += renderRow('Brand', m.common.brand);
  specsHtml += renderRow('Model', m.common.model);
  
  if (isRent) {
    specsHtml += renderRow('Working Hours', m.common.workingHours);
    specsHtml += renderRow('Idle Time', m.common.idleTime);
    specsHtml += renderRow('Fuel', m.common.fuel);
    specsHtml += renderRow('Transport', m.common.transport);
    specsHtml += renderRow('Payment Terms', m.common.paymentTerms);
  } else {
    specsHtml += renderRow('Payment Terms', m.common.paymentTerms);
    specsHtml += renderRow('Transport', m.common.transport);
  }

  let specificHtml = '';
  for (const [key, val] of Object.entries(m.specs)) {
    const label = key.replace(/([A-Z])/g, " $1").replace(/^./, str => str.toUpperCase());
    specificHtml += renderRow(label, val);
  }
  
  let buttonHTML = '';
  if (isRent) {
    if (isAvailable) {
      buttonHTML = `
        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mt-6">
          <h4 class="font-bold text-lg mb-4">Rental Period</h4>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-500 block mb-1">Start Date</label>
              <input type="date" id="rentStart" value="${startDateValue}" min="${startDateValue}" class="w-full p-2 border rounded-lg bg-white">
            </div>
            <div>
              <label class="text-xs text-gray-500 block mb-1">End Date</label>
              <input type="date" id="rentEnd" value="${endDateValue}" min="${startDateValue}" class="w-full p-2 border rounded-lg bg-white">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-500 block mb-1">Quantity</label>
              <input type="number" id="qty" min="1" value="1" class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex items-end">
              <div class="w-full bg-white p-4 rounded-xl border-2 border-gray-100">
                <p class="text-sm text-gray-600 mb-1">Estimated Total</p>
                <p class="font-heading font-bold text-2xl text-industrial-yellow" id="price">$0</p>
              </div>
            </div>
          </div>
          <p id="dateError" class="text-red-500 hidden mt-3 text-sm">
            End date must be after the start date.
          </p>
          <button onclick="addToCart(${m.id})" id="actionBtn" class="w-full py-4 bg-industrial-yellow hover:bg-orange-500 text-white font-bold rounded-xl shadow-lg transition-transform hover:scale-[1.02]">
            Add to Cart
          </button>
        </div>
      `;
    } else {
      buttonHTML = `
        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mt-6">
          <div class="text-center">
            <p class="text-red-500 font-bold mb-4">‚ö†Ô∏è Currently Rented</p>
            <p class="text-gray-600 mb-4">Available from: ${m.availableFrom}</p>
            <button onclick="addToWishlist(${m.id})" class="w-full py-4 bg-industrial-blue hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg">
              Add to Wishlist
            </button>
          </div>
        </div>
      `;
    }
  } else {
    buttonHTML = `
      <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mt-6">
        <button onclick="addToCart(${m.id})" class="w-full py-4 bg-industrial-green hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition-transform hover:scale-[1.02]">
          Inquire to Buy
        </button>
      </div>
    `;
  }

  const negHtml = `
    <div class="mt-8 border-t-2 border-gray-100 pt-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h4 class="font-heading font-bold text-xl text-industrial-gray">Negotiation & Terms</h4>
          <p class="text-sm text-gray-500">Terms not matching? Propose an offer.</p>
        </div>
        <button onclick="openNegotiation()" class="bg-white border-2 border-industrial-yellow text-industrial-yellow hover:bg-industrial-yellow hover:text-white px-6 py-2 rounded-xl font-bold transition-colors">
          Make an Offer
        </button>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-800 flex items-start gap-3">
        <span class="text-xl">üí°</span>
        <p>Prices and payment terms (${m.common.paymentTerms}) are set by the owner but open to discussion for long-term rentals or immediate purchases.</p>
      </div>
    </div>
  `;

  const content = document.getElementById('detailContent');
  content.innerHTML = `
    <!-- Header Image -->
    <div class="relative h-64 md:h-80 w-full mb-6">
      <img src="${m.image}" class="w-full h-full object-cover rounded-t-2xl md:rounded-2xl" alt="${m.name}">
      <div class="absolute bottom-0 inset-x-0 h-1/2 bg-gradient-to-t from-black/60 to-transparent rounded-b-2xl md:rounded-b-2xl"></div>
      <div class="absolute bottom-6 left-6 flex items-center space-x-4">
        <h2 class="text-3xl md:text-4xl font-heading font-bold text-white shadow-sm">${m.name}</h2>
        <div class="flex items-center space-x-1 bg-black/50 backdrop-blur-md px-3 py-1 rounded-full">
          <span class="text-yellow-500">‚≠ê</span>
          <span class="text-white font-bold">${m.rating}</span>
        </div>
      </div>
    </div>

    <div class="px-6 md:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Details Column -->
        <div class="lg:col-span-2 space-y-8">
          
          <!-- Common Specs -->
          <div>
            <h3 class="font-bold text-lg text-industrial-gray mb-3 flex items-center gap-2">
              <span>üìç</span> General Particulars
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1">
              ${specsHtml}
            </div>
          </div>

          <!-- Machine Specific Specs -->
          <div>
            <h3 class="font-bold text-lg text-industrial-gray mb-3 flex items-center gap-2">
              <span>‚öôÔ∏è</span> Technical Specifications
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1">
              ${specificHtml}
            </div>
          </div>
          
          <!-- Equipment Details -->
          <div>
            <h3 class="font-bold text-lg text-industrial-gray mb-3 flex items-center gap-2">
              <span>üîß</span> Equipment Details
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1">
              ${renderRow('Condition', `<span class="${m.condition === 'Excellent' ? 'text-green-600' : 'text-yellow-600'} font-bold">${m.condition}</span>`)}
              ${renderRow('Last Service', m.lastService)}
              ${renderRow('Status', `<span class="${m.status === 'Available' ? 'text-green-600' : 'text-red-600'} font-bold">${m.status}</span>`)}
              ${!isAvailable ? renderRow('Available From', m.availableFrom) : ''}
            </div>
          </div>
          
          <!-- Safety Notes -->
          <div class="mb-8">
            <h3 class="font-heading text-lg font-bold mb-4 text-industrial-gray flex items-center">
              <span class="text-red-500 mr-2">‚ö†Ô∏è</span> Safety & Usage Instructions
            </h3>
            <div class="bg-red-50 border-l-4 border-industrial-safety p-4 rounded-r-xl">
              <p class="text-gray-700">${m.safetyNotes}</p>
            </div>
          </div>

          <!-- Negotiation Section -->
          ${negHtml}
        </div>

        <!-- Sticky Sidebar for Action -->
        <div class="lg:col-span-1">
          <div class="sticky top-6">
            <div class="mb-2">
              <span class="text-sm text-gray-500 block">Current Listing Price</span>
              <span class="text-3xl font-heading font-bold text-industrial-dark">
                ${isRent ? `$${m.price}<span class="text-lg text-gray-400 font-normal">/day</span>` : `$${m.price.toLocaleString()}`}
              </span>
            </div>
            ${buttonHTML}
            <div class="mt-4 text-center">
              <button onclick="toggleWishlist(${m.id})" class="text-sm text-gray-500 hover:text-industrial-yellow underline">Add to Wishlist</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  if (isRent && isAvailable) {
    // Add event listeners for price calculation
    const rentStart = document.getElementById('rentStart');
    const rentEnd = document.getElementById('rentEnd');
    const qtyInput = document.getElementById('qty');
    const priceDisplay = document.getElementById('price');
    const dateError = document.getElementById('dateError');
    const actionBtn = document.getElementById('actionBtn');
    
    function updatePrice() {
      const s = new Date(rentStart.value);
      const e = new Date(rentEnd.value);
      const qty = parseInt(qtyInput.value) || 0;
      
      if (!rentStart.value || !rentEnd.value || e <= s) {
        if (rentStart.value && rentEnd.value) {
          dateError.classList.remove("hidden");
          actionBtn.disabled = true;
        }
        priceDisplay.textContent = "$0";
        return;
      }
      
      dateError.classList.add("hidden");
      actionBtn.disabled = false;
      
      const days = Math.ceil((e - s) / (1000 * 60 * 60 * 24));
      const total = m.price * days * qty;
      priceDisplay.textContent = total > 0 ? `$${total}` : "$0";
    }
    
    rentStart.addEventListener('change', function() {
      rentEnd.min = this.value;
      updatePrice();
    });
    
    rentEnd.addEventListener('change', updatePrice);
    qtyInput.addEventListener('change', updatePrice);
    
    updatePrice();
  }
  
  document.getElementById('detailModal').classList.remove('hidden');
}

function openNegotiation() {
  const machines = JSON.parse(localStorage.getItem("machines"));
  const m = machines.find(x => x.id === currentMachineId);
  const isRent = m.listingType === 'Rent';
  
  document.getElementById('currencyLabel').innerText = isRent ? "Daily Rate ($)" : "Total Price ($)";
  document.getElementById('offerPrice').placeholder = m.price;
  document.getElementById('offerPrice').value = '';
  document.getElementById('offerNotes').value = '';
  
  const termsSelect = document.getElementById('offerTerms');
  for(let i=0; i<termsSelect.options.length; i++){
    if(m.common.paymentTerms.includes(termsSelect.options[i].value)){
      termsSelect.selectedIndex = i;
      break;
    }
  }

  document.getElementById('negotiationModal').classList.remove('hidden');
}

function submitNegotiation(e) {
  e.preventDefault();
  closeNegotiation();
  closeDetail();
  
  const modal = document.getElementById('confirmModal');
  modal.querySelector('h2').innerText = "Offer Submitted!";
  modal.querySelector('p').innerText = "The owner has received your offer. Negotiation status will be updated in your dashboard.";
  modal.classList.remove('hidden');
}

function closeNegotiation() {
  document.getElementById('negotiationModal').classList.add('hidden');
}

function closeDetail() {
  document.getElementById('detailModal').classList.add('hidden');
}

function toggleWishlist(id) {
  const wishlist = JSON.parse(localStorage.getItem("wishlist"));
  const machines = JSON.parse(localStorage.getItem("machines"));
  const m = machines.find(x => x.id === id);
  
  const existingIndex = wishlist.findIndex(item => item.machineId === id);
  
  if (existingIndex !== -1) {
    wishlist.splice(existingIndex, 1);
    alert("Removed from wishlist");
  } else {
    wishlist.push({
      machineId: id,
      addedDate: new Date().toISOString().split('T')[0],
      availableFrom: m.availableFrom
    });
    alert("Added to wishlist!");
  }
  
  localStorage.setItem("wishlist", JSON.stringify(wishlist));
  updateNavigationBadges();
}
/* ---------- CART FUNCTIONS ---------- */
function addToCart(id) {
  const machines = JSON.parse(localStorage.getItem("machines"));
  const m = machines.find(x => x.id === id);
  let cart = JSON.parse(localStorage.getItem("cart"));
  
  if (m.listingType === 'Rent') {
    const rentStart = document.getElementById('rentStart');
    const rentEnd = document.getElementById('rentEnd');
    const qtyInput = document.getElementById('qty');
    
    if (!rentStart || !rentEnd || !qtyInput) {
      alert("Please select rental dates and quantity");
      return;
    }
    
    const s = rentStart.value;
    const e = rentEnd.value;
    const qty = parseInt(qtyInput.value);
    
    if(!s || !e) { 
      alert("Please select rental dates"); 
      return; 
    }
    
    const d1 = new Date(s);
    const d2 = new Date(e);
    const diffTime = Math.abs(d2 - d1);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    if (diffDays <= 0) { 
      alert("Invalid date range"); 
      return; 
    }
    
    if (qty <= 0) {
      alert("Quantity must be at least 1");
      return;
    }
    
    cart.push({
      machineId: m.id,
      machine: {
        id: m.id,
        name: m.name,
        price: m.price,
        image: m.image,
        listingType: m.listingType
      },
      duration: diffDays,
      dates: `${s} to ${e}`,
      quantity: qty,
      startDate: s,
      endDate: e,
      isRental: true,
      addedAt: new Date()
    });
  } else {
    cart.push({
      machineId: m.id,
      machine: {
        id: m.id,
        name: m.name,
        price: m.price,
        image: m.image,
        listingType: m.listingType
      },
      isRental: false,
      addedAt: new Date()
    });
  }
  
  localStorage.setItem("cart", JSON.stringify(cart));
  updateNavigationBadges();
  closeDetail();
  alert("Item added to cart!");
}

function openCart() {
  const cart = JSON.parse(localStorage.getItem("cart"));
  const container = document.getElementById("cartItems");
  const totalEl = document.getElementById("cartTotal");
  
  container.innerHTML = "";
  let total = 0;

  if (cart.length === 0) {
    container.innerHTML = "<div class='text-center py-12'><div class='text-6xl mb-4'>üõí</div><p class='text-gray-500'>Your cart is empty.</p></div>";
    totalEl.innerText = "$0";
  } else {
    cart.forEach((item, index) => {
      // Safely access the machine object
      const machine = item.machine || {};
      const price = machine.price || 0;
      const name = machine.name || "Unknown Item";
      const image = machine.image || "";
      
      const cost = item.isRental ? (price * item.duration * item.quantity) : price;
      total += cost;

      container.innerHTML += `
        <div class="flex justify-between items-center border-b pb-4">
          <div class="flex items-center space-x-4">
            ${image ? `<img src="${image}" class="w-16 h-16 rounded-lg object-cover">` : '<div class="w-16 h-16 bg-gray-200 rounded-lg"></div>'}
            <div>
              <p class="font-bold">${name}</p>
              <p class="text-xs text-gray-500">${item.isRental ? `Rent: ${item.quantity} √ó ${item.duration} Days (${item.dates})` : 'Purchase Inquiry'}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold">$${cost.toLocaleString()}</p>
            <button onclick="removeFromCart(${index})" class="text-xs text-red-500 underline">Remove</button>
          </div>
        </div>
      `;
    });
    totalEl.innerText = "$" + total.toLocaleString();
  }
  
  document.getElementById("cartModal").classList.remove("hidden");
}

function removeFromCart(index) {
  let cart = JSON.parse(localStorage.getItem("cart"));
  cart.splice(index, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  openCart();
  updateNavigationBadges();
}

function closeCart() {
  document.getElementById("cartModal").classList.add("hidden");
}

/* ---------- BOOKING MODAL FUNCTIONS ---------- */
function openCompleteBookingModal() {
  const cart = JSON.parse(localStorage.getItem("cart"));
  if (cart.length === 0) {
    alert("Your cart is empty. Please add items to book.");
    return;
  }
  
  currentStep = 1;
  selectedDeliveryOption = null;
  selectedPaymentMethod = null;
  
  updateProgressBar();
  
  document.querySelectorAll('[id^="step"]').forEach(step => {
    step.classList.add('hidden');
  });
  document.getElementById('step1').classList.remove('hidden');
  
  document.querySelectorAll('.delivery-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.querySelectorAll('.payment-method').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  document.getElementById('bookingName').value = '';
  document.getElementById('bookingEmail').value = '';
  document.getElementById('bookingPhone').value = '';
  document.getElementById('bookingCompany').value = '';
  document.getElementById('bookingAddress').value = '';
  document.getElementById('deliveryDate').value = '';
  document.getElementById('deliveryTime').value = '';
  document.getElementById('deliveryInstructions').value = '';
  document.getElementById('termsAgreement').checked = false;
  document.getElementById('bankTransferInfo').classList.add('hidden');
  document.getElementById('deliveryDetails').classList.add('hidden');
  
  closeCart();
  document.getElementById('completeBookingModal').classList.remove('hidden');
}

function closeCompleteBookingModal() {
  document.getElementById('completeBookingModal').classList.add('hidden');
}

function updateProgressBar() {
  const progress = (currentStep / 4) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
  
  document.querySelectorAll('.step-number').forEach((step, index) => {
    step.classList.remove('active', 'completed');
    if (index + 1 <= currentStep) {
      step.classList.add('active');
    }
  });
}

function nextStep(step) {
  if (currentStep === 1) {
    if (!validateStep1()) return;
  } else if (currentStep === 2) {
    if (!validateStep2()) return;
  } else if (currentStep === 3) {
    if (!validateStep3()) return;
  }
  
  currentStep = step;
  updateProgressBar();
  
  document.querySelectorAll('[id^="step"]').forEach(step => {
    step.classList.add('hidden');
  });
  
  document.getElementById(`step${step}`).classList.remove('hidden');
  
  if (step === 4) {
    populateReview();
  }
}

function prevStep(step) {
  currentStep = step;
  updateProgressBar();
  
  document.querySelectorAll('[id^="step"]').forEach(step => {
    step.classList.add('hidden');
  });
  
  document.getElementById(`step${step}`).classList.remove('hidden');
}

function validateStep1() {
  const name = document.getElementById('bookingName').value.trim();
  const email = document.getElementById('bookingEmail').value.trim();
  const phone = document.getElementById('bookingPhone').value.trim();
  
  if (!name) {
    alert("Please enter your full name.");
    return false;
  }
  
  if (!email) {
    alert("Please enter your email address.");
    return false;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert("Please enter a valid email address.");
    return false;
  }
  
  if (!phone) {
    alert("Please enter your phone number.");
    return false;
  }
  
  return true;
}

function validateStep2() {
  if (!selectedDeliveryOption) {
    alert("Please select a delivery option.");
    return false;
  }
  
  if (selectedDeliveryOption === 'delivery') {
    const address = document.getElementById('bookingAddress').value.trim();
    const deliveryDate = document.getElementById('deliveryDate').value;
    const deliveryTime = document.getElementById('deliveryTime').value;
    
    if (!address) {
      alert("Please enter a delivery address. Address is required for delivery.");
      return false;
    }
    
    if (!deliveryDate) {
      alert("Please select a delivery date.");
      return false;
    }
    
    if (!deliveryTime) {
      alert("Please select a delivery time window.");
      return false;
    }
  }
  
  return true;
}

function validateStep3() {
  if (!selectedPaymentMethod) {
    alert("Please select a payment method.");
    return false;
  }
  
  return true;
}

function selectDeliveryOption(option, element) {
  selectedDeliveryOption = option;
  
  document.querySelectorAll('.delivery-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  element.classList.add('selected');
  
  if (option === 'delivery') {
    document.getElementById('deliveryDetails').classList.remove('hidden');
  } else {
    document.getElementById('deliveryDetails').classList.add('hidden');
  }
}

function selectPaymentMethod(method, element) {
  selectedPaymentMethod = method;
  
  document.querySelectorAll('.payment-method').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  element.classList.add('selected');
  
  if (method === 'bank') {
    document.getElementById('bankTransferInfo').classList.remove('hidden');
  } else {
    document.getElementById('bankTransferInfo').classList.add('hidden');
  }
}

function populateReview() {
  const cart = JSON.parse(localStorage.getItem("cart"));
  let total = 0;
  
  let orderSummaryHTML = '';
  cart.forEach(item => {
    const cost = item.isRental ? (item.machine.price * item.quantity * item.duration) : item.machine.price;
    total += cost;
    
    orderSummaryHTML += `
      <div class="flex justify-between items-center py-3 border-b border-gray-200">
        <div>
          <p class="font-medium">${item.machine.name}</p>
          <p class="text-sm text-gray-600">${item.isRental ? `${item.quantity} √ó $${item.machine.price}/day √ó ${item.duration} days` : 'Purchase'}</p>
          ${item.isRental ? `<p class="text-sm text-gray-600">${item.startDate} to ${item.endDate}</p>` : ''}
        </div>
        <p class="font-bold">$${cost}</p>
      </div>
    `;
  });
  
  document.getElementById('orderSummary').innerHTML = orderSummaryHTML;
  document.getElementById('orderTotal').textContent = `$${total}`;
  
  const customerInfo = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <p class="text-sm text-gray-600">Name</p>
        <p class="font-medium">${document.getElementById('bookingName').value}</p>
      </div>
      <div>
        <p class="text-sm text-gray-600">Email</p>
        <p class="font-medium">${document.getElementById('bookingEmail').value}</p>
      </div>
      <div>
        <p class="text-sm text-gray-600">Phone</p>
        <p class="font-medium">${document.getElementById('bookingPhone').value}</p>
      </div>
      <div>
        <p class="text-sm text-gray-600">Company</p>
        <p class="font-medium">${document.getElementById('bookingCompany').value || 'Not provided'}</p>
      </div>
      <div class="md:col-span-2">
        <p class="text-sm text-gray-600">Address</p>
        <p class="font-medium">${document.getElementById('bookingAddress').value || (selectedDeliveryOption === 'pickup' ? 'Pickup at warehouse' : 'Not provided')}</p>
      </div>
    </div>
  `;
  document.getElementById('customerInfo').innerHTML = customerInfo;
  
  let deliveryInfo = '';
  if (selectedDeliveryOption === 'pickup') {
    deliveryInfo = `
      <p class="text-sm text-gray-600 mb-2">Delivery Method</p>
      <p class="font-medium">Pickup at Warehouse</p>
      <p class="text-sm text-gray-600 mt-4">Pickup Address</p>
      <p class="font-medium">789 Industrial Way, City, State 12345</p>
    `;
  } else {
    deliveryInfo = `
      <p class="text-sm text-gray-600 mb-2">Delivery Method</p>
      <p class="font-medium">Delivery to Site</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <p class="text-sm text-gray-600">Delivery Date</p>
          <p class="font-medium">${document.getElementById('deliveryDate').value}</p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Time Window</p>
          <p class="font-medium">${document.getElementById('deliveryTime').options[document.getElementById('deliveryTime').selectedIndex].text}</p>
        </div>
      </div>
      ${document.getElementById('deliveryInstructions').value ? `
        <div class="mt-4">
          <p class="text-sm text-gray-600">Special Instructions</p>
          <p class="font-medium">${document.getElementById('deliveryInstructions').value}</p>
        </div>
      ` : ''}
    `;
  }
  
  let paymentInfo = '';
  if (selectedPaymentMethod === 'cash') {
    paymentInfo = `
      <p class="text-sm text-gray-600 mb-2">Payment Method</p>
      <p class="font-medium">Cash on Delivery/Acceptance</p>
      <p class="text-sm text-gray-600 mt-2">Pay when equipment is delivered or picked up</p>
    `;
  } else {
    paymentInfo = `
      <p class="text-sm text-gray-600 mb-2">Payment Method</p>
      <p class="font-medium">Bank Transfer</p>
      <p class="text-sm text-gray-600 mt-2">Payment verification required before confirmation</p>
    `;
  }
  
  document.getElementById('deliveryPaymentInfo').innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-xl">
        ${deliveryInfo}
      </div>
      <div class="bg-white p-4 rounded-xl">
        ${paymentInfo}
      </div>
    </div>
  `;
}

function submitBooking() {
  if (!document.getElementById('termsAgreement').checked) {
    alert("Please agree to the Terms and Conditions to proceed.");
    return;
  }
  
  document.getElementById('submitButtonText').textContent = 'Processing...';
  document.getElementById('loadingSpinner').classList.remove('hidden');
  
  setTimeout(() => {
    const cart = JSON.parse(localStorage.getItem("cart"));
    const machines = JSON.parse(localStorage.getItem("machines"));
    let orders = JSON.parse(localStorage.getItem("orders"));
    
    const orderId = generateOrderId();
    const now = new Date().toISOString();
    
    let total = 0;
    cart.forEach(item => {
      const m = machines.find(x => x.id === item.machineId);
      total += item.isRental ? (m.price * item.quantity * item.duration) : m.price;
    });
    
    const order = {
      id: orderId,
      date: now,
      status: selectedPaymentMethod === 'cash' ? 'pending' : 'pending_payment',
      paymentMethod: selectedPaymentMethod,
      paymentStatus: selectedPaymentMethod === 'cash' ? 'pending' : 'pending_verification',
      deliveryMethod: selectedDeliveryOption,
      total: total,
      items: [...cart],
      customer: {
        name: document.getElementById('bookingName').value,
        email: document.getElementById('bookingEmail').value,
        phone: document.getElementById('bookingPhone').value,
        company: document.getElementById('bookingCompany').value,
        address: document.getElementById('bookingAddress').value
      },
      delivery: selectedDeliveryOption === 'delivery' ? {
        date: document.getElementById('deliveryDate').value,
        time: document.getElementById('deliveryTime').value,
        instructions: document.getElementById('deliveryInstructions').value
      } : null,
      notes: ''
    };
    
    orders.push(order);
    localStorage.setItem("orders", JSON.stringify(orders));
    
     cart.forEach(item => {
      const m = machines.find(x => x.id === item.machineId);
      if (m && item.isRental) {
        m.status = "Rented";
        const availableDate = new Date(item.endDate);
        availableDate.setDate(availableDate.getDate() + 1);
        m.availableFrom = availableDate.toISOString().split('T')[0];
        
        // Ensure bookings array exists
        if (!m.bookings) {
          m.bookings = [];
        }
        
        m.bookings.push({
          orderId: orderId,
          days: item.duration,
          startDate: item.startDate,
          endDate: item.endDate,
          quantity: item.quantity
        });
      }
    });
    
    localStorage.setItem("machines", JSON.stringify(machines));
    localStorage.setItem("cart", JSON.stringify([]));
    updateNavigationBadges();
    closeCompleteBookingModal();
    
    if (selectedPaymentMethod === 'cash') {
      document.getElementById('confirmTitle').textContent = 'Booking Placed!';
      document.getElementById('confirmMessage').textContent = 'Your order has been placed. Please be ready with cash payment when equipment is delivered/picked up.';
      document.getElementById('confirmIcon').textContent = 'üìã';
    } else {
      document.getElementById('confirmTitle').textContent = 'Order Created!';
      document.getElementById('confirmMessage').textContent = 'Your order has been created. Please complete bank transfer to confirm booking. Use the Order ID below as reference.';
      document.getElementById('confirmIcon').textContent = 'üè¶';
    }
    
    document.getElementById('orderIdDisplay').textContent = `Order ID: ${orderId}`;
    document.getElementById('confirmModal').classList.remove('hidden');
    
    document.getElementById('submitButtonText').textContent = 'Confirm & Place Order';
    document.getElementById('loadingSpinner').classList.add('hidden');
    
    renderMachines();
    
  }, 1500);
}

/* ---------- ORDERS MODAL FUNCTIONS ---------- */
function openOrders() {
  loadOrders('all');
  document.getElementById('ordersModal').classList.remove('hidden');
}

function closeOrders() {
  document.getElementById('ordersModal').classList.add('hidden');
}

function loadOrders(filter = 'all') {
  const orders = JSON.parse(localStorage.getItem("orders"));
  const machines = JSON.parse(localStorage.getItem("machines"));
  const ordersList = document.getElementById('ordersList');
  const noOrders = document.getElementById('noOrders');
  
  ordersList.innerHTML = '';
  
  let filteredOrders = orders;
  if (filter !== 'all') {
    filteredOrders = orders.filter(order => {
      if (filter === 'pending') return order.status === 'pending';
      if (filter === 'confirmed') return order.status === 'confirmed';
      if (filter === 'completed') return order.status === 'completed';
      if (filter === 'cancelled') return order.status === 'cancelled';
      return true;
    });
  }
  
  if (filteredOrders.length === 0) {
    ordersList.classList.add('hidden');
    noOrders.classList.remove('hidden');
    return;
  }
  
  noOrders.classList.add('hidden');
  ordersList.classList.remove('hidden');
  
  filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  filteredOrders.forEach(order => {
    let statusColor = 'bg-gray-500';
    let statusText = 'Unknown';
    
    switch(order.status) {
      case 'pending':
        statusColor = 'bg-yellow-500';
        statusText = 'Pending';
        break;
      case 'pending_payment':
        statusColor = 'bg-blue-500';
        statusText = 'Awaiting Payment';
        break;
      case 'confirmed':
        statusColor = 'bg-green-500';
        statusText = 'Confirmed';
        break;
      case 'completed':
        statusColor = 'bg-industrial-green';
        statusText = 'Completed';
        break;
      case 'cancelled':
        statusColor = 'bg-red-500';
        statusText = 'Cancelled';
        break;
    }
    
    const orderDate = new Date(order.date);
    const formattedDate = orderDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    
    const machineNames = order.items.map(item => {
      const m = machines.find(x => x.id === item.machineId);
      return m ? `${m.name} ${item.quantity ? `(x${item.quantity})` : ''}` : 'Unknown Machine';
    }).join(', ');
    
    ordersList.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-6 bg-gradient-to-r from-gray-50 to-white">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="font-heading font-bold text-lg">Order: ${order.id}</h3>
            <p class="text-gray-600 text-sm">Placed on ${formattedDate}</p>
          </div>
          <span class="px-3 py-1 rounded-full text-sm font-bold text-white ${statusColor}">
            ${statusText}
          </span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <div>
            <p class="text-sm text-gray-600">Items</p>
            <p class="font-medium">${machineNames}</p>
            <p class="text-sm text-gray-600 mt-2">Delivery Method</p>
            <p class="font-medium">${order.deliveryMethod === 'pickup' ? 'Pickup' : 'Delivery'}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Payment Method</p>
            <p class="font-medium">${order.paymentMethod === 'cash' ? 'Cash on Delivery' : 'Bank Transfer'}</p>
            <p class="text-sm text-gray-600 mt-2">Payment Status</p>
            <p class="font-medium">${order.paymentStatus === 'pending' ? 'Pending' : order.paymentStatus === 'pending_verification' ? 'Awaiting Verification' : 'Paid'}</p>
          </div>
        </div>
        
        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
          <div>
            <p class="text-sm text-gray-600">Total Amount</p>
            <p class="font-heading font-bold text-xl text-industrial-yellow">$${order.total}</p>
          </div>
          <div class="space-x-2">
            ${order.status === 'pending_payment' ? `
              <button onclick="showPaymentInstructions('${order.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-xl text-sm font-medium">
                View Payment Instructions
              </button>
            ` : ''}
            <button onclick="viewOrderDetails('${order.id}')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-xl text-sm font-medium">
              View Details
            </button>
          </div>
        </div>
      </div>
    `;
  });
}

function filterOrders(filter) {
  loadOrders(filter);
}

function viewOrderDetails(orderId) {
  const orders = JSON.parse(localStorage.getItem("orders"));
  const machines = JSON.parse(localStorage.getItem("machines"));
  const order = orders.find(o => o.id === orderId);
  
  if (!order) return;
  
  let orderDetails = `
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
      <h3 class="font-heading font-bold text-2xl mb-4">Order Details: ${order.id}</h3>
      
      <div class="space-y-6">
        <div>
          <h4 class="font-bold text-lg mb-2">Order Items</h4>
          ${order.items.map(item => {
            const m = machines.find(x => x.id === item.machineId);
            return `
              <div class="flex justify-between items-center py-3 border-b border-gray-200">
                <div>
                  <p class="font-medium">${m ? m.name : 'Unknown Machine'}</p>
                  ${item.quantity ? `<p class="text-sm text-gray-600">Quantity: ${item.quantity} | Days: ${item.duration}</p>` : ''}
                  ${item.startDate ? `<p class="text-sm text-gray-600">Dates: ${item.startDate} to ${item.endDate}</p>` : ''}
                </div>
                <p class="font-medium">$${m ? (item.quantity ? m.price * item.quantity * item.duration : m.price) : 0}</p>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-bold text-lg mb-2">Customer Information</h4>
            <p><span class="text-gray-600">Name:</span> ${order.customer.name}</p>
            <p><span class="text-gray-600">Email:</span> ${order.customer.email}</p>
            <p><span class="text-gray-600">Phone:</span> ${order.customer.phone}</p>
            ${order.customer.company ? `<p><span class="text-gray-600">Company:</span> ${order.customer.company}</p>` : ''}
            <p><span class="text-gray-600">Address:</span> ${order.customer.address || 'Pickup'}</p>
          </div>
          
          <div>
            <h4 class="font-bold text-lg mb-2">Order Information</h4>
            <p><span class="text-gray-600">Order Date:</span> ${new Date(order.date).toLocaleDateString()}</p>
            <p><span class="text-gray-600">Status:</span> ${order.status}</p>
            <p><span class="text-gray-600">Payment Method:</span> ${order.paymentMethod === 'cash' ? 'Cash on Delivery' : 'Bank Transfer'}</p>
            <p><span class="text-gray-600">Payment Status:</span> ${order.paymentStatus}</p>
            <p><span class="text-gray-600">Delivery:</span> ${order.deliveryMethod === 'pickup' ? 'Pickup' : 'Delivery'}</p>
            ${order.delivery ? `
              <p><span class="text-gray-600">Delivery Date:</span> ${order.delivery.date}</p>
              <p><span class="text-gray-600">Delivery Time:</span> ${order.delivery.time}</p>
            ` : ''}
          </div>
        </div>
        
        <div class="text-center pt-4 border-t border-gray-200">
          <p class="font-heading font-bold text-2xl text-industrial-yellow">Total: $${order.total}</p>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay';
  modal.innerHTML = `
    <div class="relative modal-content" onclick="event.stopPropagation()">
      <button onclick="this.parentElement.parentElement.remove()" class="absolute -top-10 right-0 text-white text-2xl">&times;</button>
      ${orderDetails}
    </div>
  `;
  
  document.body.appendChild(modal);
  
  modal.onclick = function(event) {
    if (event.target.classList.contains('modal-overlay')) {
      modal.remove();
    }
  };
}

function showPaymentInstructions(orderId) {
  const orders = JSON.parse(localStorage.getItem("orders"));
  const order = orders.find(o => o.id === orderId);
  
  if (!order) return;
  
  const instructions = `
    <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg mx-auto modal-content" onclick="event.stopPropagation()">
      <h3 class="font-heading font-bold text-2xl mb-4 text-blue-800">Payment Instructions</h3>
      
      <div class="space-y-4">
        <div class="bg-blue-50 p-4 rounded-xl">
          <p class="font-bold text-blue-800 mb-2">Order ID: ${order.id}</p>
          <p class="text-blue-700">Please use this Order ID as payment reference</p>
        </div>
        
        <div>
          <h4 class="font-bold text-gray-700 mb-2">Bank Details:</h4>
          <div class="bg-gray-100 p-4 rounded-xl">
            <p><span class="font-medium">Bank:</span> First National Bank</p>
            <p><span class="font-medium">Account:</span> 1234567890</p>
            <p><span class="font-medium">Routing:</span> 021000021</p>
            <p><span class="font-medium">Amount:</span> $${order.total}</p>
          </div>
        </div>
        
        <div>
          <h4 class="font-bold text-gray-700 mb-2">Upload Proof of Payment</h4>
          <p class="text-sm text-gray-600 mb-3">Upload a screenshot or PDF of your bank transfer confirmation</p>
          <input type="file" id="paymentProofFile" accept=".pdf,.jpg,.jpeg,.png" 
            class="w-full border-2 border-gray-300 p-3 rounded-xl mb-3">
          <button onclick="uploadPaymentProof('${orderId}')" 
            class="w-full bg-industrial-green hover:bg-green-600 text-white py-3 rounded-xl font-bold">
            Upload & Submit for Verification
          </button>
        </div>
        
        <div>
          <h4 class="font-bold text-gray-700 mb-2">Important Notes:</h4>
          <ul class="list-disc pl-5 space-y-2 text-gray-600">
            <li>Your booking will be confirmed within 24 hours after payment verification</li>
            <li>Keep your payment receipt/screenshot for reference</li>
            <li>Contact support@medish machinary.com for assistance</li>
            <li>Order will be automatically cancelled after 48 hours if payment is not received</li>
          </ul>
        </div>
        
        <div class="text-center mt-6">
          <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
            class="bg-industrial-yellow hover:bg-orange-500 text-white px-6 py-3 rounded-xl font-bold">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4 modal-overlay';
  modal.innerHTML = instructions;
  
  document.body.appendChild(modal);
  
  modal.onclick = function(event) {
    if (event.target.classList.contains('modal-overlay')) {
      modal.remove();
    }
  };
}

function uploadPaymentProof(orderId) {
  const fileInput = document.getElementById('paymentProofFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert("Please select a file to upload.");
    return;
  }
  
  if (file.size > 5 * 1024 * 1024) {
    alert("File is too large. Maximum size is 5MB.");
    return;
  }
  
  const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  if (!validTypes.includes(file.type)) {
    alert("Invalid file type. Please upload PDF, JPG, or PNG.");
    return;
  }
  
  const uploadBtn = fileInput.nextElementSibling;
  const originalText = uploadBtn.textContent;
  uploadBtn.textContent = 'Uploading...';
  uploadBtn.disabled = true;
  
  setTimeout(() => {
    const orders = JSON.parse(localStorage.getItem("orders"));
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
      orders[orderIndex].paymentProof = {
        fileName: file.name,
        uploadDate: new Date().toISOString(),
        status: 'pending_verification'
      };
      
      localStorage.setItem("orders", JSON.stringify(orders));
      alert("Payment proof uploaded successfully! We'll verify your payment within 24 hours.");
      document.querySelector('.modal-overlay').remove();
      loadOrders('pending');
    }
    
    uploadBtn.textContent = originalText;
    uploadBtn.disabled = false;
  }, 1500);
}

/* ---------- WISHLIST FUNCTIONS ---------- */
function openWishlist() {
  const wishlist = JSON.parse(localStorage.getItem("wishlist"));
  const machines = JSON.parse(localStorage.getItem("machines"));
  const wishlistItems = document.getElementById("wishlistItems");
  wishlistItems.innerHTML = "";

  if (wishlist.length === 0) {
    wishlistItems.innerHTML = `<div class="text-center py-12">
      <div class="text-6xl mb-4">üíõ</div>
      <h3 class="font-heading text-xl font-bold text-gray-700 mb-2">Your wishlist is empty</h3>
      <p class="text-gray-500">Add unavailable items to be notified when they're back</p>
    </div>`;
    document.getElementById("wishlistModal").classList.remove("hidden");
    return;
  }
  
  wishlist.forEach((item, i) => {
    const m = machines.find(x => x.id === item.machineId);
    if (!m) return;

    wishlistItems.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-5 mb-4 bg-gradient-to-r from-gray-50 to-white">
        <div class="flex flex-col md:flex-row md:items-center justify-between">
          <div class="flex-1 mb-4 md:mb-0">
            <div class="flex items-center space-x-4">
              <img src="${m.image}" class="h-16 w-16 object-cover rounded-xl" alt="${m.name}">
              <div>
                <p class="font-heading font-bold text-lg text-industrial-gray">${m.name}</p>
                <p class="text-sm text-gray-600">${m.type} - $${m.price}/${m.listingType === 'Rent' ? 'day' : ''}</p>
                <p class="text-xs text-blue-500 font-semibold mt-2">Will be available from: ${item.availableFrom || m.availableFrom}</p>
              </div>
            </div>
          </div>
          <div class="mt-4 md:mt-0">
            <button onclick="removeFromWishlist(${i})" class="text-red-600 hover:text-red-800 text-sm py-2 px-4 rounded-lg border border-red-200 hover:border-red-300 bg-red-50 hover:bg-red-100 transition-colors duration-200">
              Remove
            </button>
          </div>
        </div>
      </div>
    `;
  });

  document.getElementById("wishlistModal").classList.remove("hidden");
}

function removeFromWishlist(index) {
  const wishlist = JSON.parse(localStorage.getItem("wishlist"));
  wishlist.splice(index, 1);
  localStorage.setItem("wishlist", JSON.stringify(wishlist));
  updateNavigationBadges();
  openWishlist();
}

function closeWishlist() {
  document.getElementById("wishlistModal").classList.add("hidden");
}

function closeConfirm() {
  document.getElementById("confirmModal").classList.add("hidden");
}

/* ---------- INITIALIZATION ---------- */
function initCategoryFilter() {
  const categories = [...new Set(initialMachines.map(m => m.type))];
  const filterSel = document.getElementById("categoryFilter");
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.innerText = c;
    filterSel.appendChild(opt);
  });
}

// Initialize
initCategoryFilter();
renderMachines();
updateNavigationBadges();

// Add keyboard shortcut for search
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
});

// Ensure functions are globally accessible
window.openCart = openCart;
window.closeCart = closeCart;
window.openOrders = openOrders;
window.openWishlist = openWishlist;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded - cart functionality ready');
  updateNavigationBadges();
});

</script>
</body>
</html>